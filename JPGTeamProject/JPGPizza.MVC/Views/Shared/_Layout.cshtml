<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,900" rel="stylesheet">
    <title>@ViewBag.Title - My ASP.NET Application</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")


</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                @Html.ActionLink("JPGPizza", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav uppercase-black">
                    <li>@Html.ActionLink("Категории", "Categories", "Products")</li>
                    <li>@Html.ActionLink("За нас", "About", "Home")</li>
                    <li>@Html.ActionLink("Контакти", "Contact", "Home")</li>

                    @if (User.IsInRole("Administrator"))
                    {
                        <li>@Html.ActionLink("Управление", "Index", "Administrators")</li>
                    }
                    <li>
                        <button type="button" class="btn btn-info btn-md" data-toggle="modal" data-target="#orderModal">Поръчай сега</button>
                    </li>
                    @*<li><a href="#" class="button order-btn" data-type="order">Поръчай сега</a></li>*@
                    <li>
                        <a class="shopping-cart" href="#" data-toggle="modal" data-target="#shoppingCartModal">
                            <span class="glyphicon glyphicon-shopping-cart"></span>
                            <span class="badge"></span>
                        </a>
                    </li>
                </ul>


                @Html.Partial("_LoginPartial")
            </div>
        </div>
    </div>
    <div class="container body-content">
        @{ Html.RenderPartial("_Notifications"); }
        @RenderBody()
    </div>


    <!-- Trigger the modal with a button -->
    <!-- Modal -->
    <div class="modal fade" id="shoppingCartModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">КОЛИЧКА</h4>
                </div>
                <div class="modal-body">
                    <div id="shopping-cart-list">
                        <span>
                            Количката е празна.
                        </span>

                    </div>

                </div>
                <div class="modal-footer">
                    <a class="btn btn-default btn-secondary pull-left" id="empyShoppingCart">Изчисти количката</a>
                    <button type="button" class="btn btn-primary" id="finish-Order">Завърши поръчката</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Изберете начин на поръчка</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-2"></div>
                        <div class="col-md-4">

                            <a href=@Url.Action("Delivery", "Orders")>
                                <img style="max-width: 150px;
                                                height: 150px;" src="~/Content/Images/delivery.png" />
                                <p style="text-align:center">За вкъщи</p>
                            </a>


                        </div>
                        <div class="col-md-4">

                            <a href="@Url.Action("CarryOut", "Orders")">
                                <img style="max-width: 150px;
                                                height: 150px;" src="~/Content/Images/shop.png" />
                                <p style="text-align:center"> Вземане от място</p>
                            </a>


                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Затвори</button>
                </div>
            </div>
        </div>
    </div>


    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)

    <script>
        $(document).ready(() => {
            if (sessionStorage.getItem('shoppingCart') != null) {
                $('.badge').text(JSON.parse(sessionStorage.getItem('shoppingCart')).length);          
            }
            
            $('.shopping-cart').click((ev) => {
                appendToShoppingCart();
            })
            $('#empyShoppingCart').click((ev) => {
                sessionStorage.setItem('shoppingCart', JSON.stringify([]));
                appendToShoppingCart();
            })
            $('#logout-btn').click((ev) => {
                sessionStorage.setItem('shoppingCart', JSON.stringify([]));
            });
            $('#finish-Order').click((ev) => {
                finishOrder();
            });
        });

        function appendToShoppingCart() {
            let shoppingCart = JSON.parse(sessionStorage.getItem('shoppingCart'));
            let productsInCart = ``;
            if (shoppingCart.length >= 0) {
                $('.badge').text(JSON.parse(sessionStorage.getItem('shoppingCart')).length);
                let total = 0;
                productsInCart += `<div class="row">
                            <div class="col-sm-3">
                                <span>`+ "Продукт" + `</span>
                            </div>
                            <div class="col-sm-3" style="padding-left: 20px;">`
                    + "Количество" +
                    `</div>
                             <div class="col-sm-3">`
                    + "Цена" +
                    `</div>
                        </div>
                        <hr/>`
                for (let orderProduct of shoppingCart) {
                    total += orderProduct.price;
                    productsInCart +=
                        `<div class="row">
                            <div class="col-sm-3">
                                <span>`+ orderProduct.name + `</span>
                            </div>
                            <div class="col-sm-3" style="padding-left: 20px;">`
                            + orderProduct.quantity + " бр." +
                            `</div>
                                 <div class="col-sm-3">`
                            + orderProduct.price.toFixed(2) + " лв." +
                            `</div>
                             <div class="col-sm-3">
                                <a class="removeFromCart" data-product-id-value=`+ orderProduct.id +`><span class="glyphicon glyphicon-remove"></span></a>
                            </div>
                        </div>                        
                        <hr/>`;
                }
                productsInCart += `<div class="row">
                                     <span class="col-sm-5">`+ "Общо: " + `</span>
                                     <span class="col-sm-5">`+ total.toFixed(2) + " лв." + `</span>
                                   </div>`

                $('#shopping-cart-list span').empty();
                $('#shopping-cart-list span').append(productsInCart);
                removeFromCart(shoppingCart);
            }
        }

        function finishOrder() {
            let shoppingCart = sessionStorage.getItem('shoppingCart');                     
            var controllerUrl = "@Url.Action("ShopingCartList", "Orders")"            
            $.ajax({
                type: "POST",
                url: controllerUrl,
                data: shoppingCart,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    alert(msg);
                }
            });
        }

        function removeFromCart(shoppingCart) {
            $('.removeFromCart').click((ev) => {

                let evTarget = $(ev.currentTarget);
                let productId = ev.currentTarget.getAttribute('data-product-id-value');
                let index = getIndexById(shoppingCart, productId);
                if (index != null) {
                    shoppingCart.splice(index, 1);
                    sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
                }
                appendToShoppingCart();
            });
        }
        function getIndexById(shoppingCart, productId) {
            for (var i = 0; i < shoppingCart.length; i++) {
                if (shoppingCart[i].id === productId) {
                    return i;
                }                
            }
            return null;
        }

        

    </script>

</body>
</html>
